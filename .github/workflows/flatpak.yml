name: Build Flatpak

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  flatpak:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Flatpak and builder
        run: |
          sudo apt update
          sudo apt install -y flatpak flatpak-builder elfutils

      - name: Add Flathub remote and install SDK/runtime
        run: |
          flatpak remote-add --if-not-exists flathub https://dl.flathub.org/repo/flathub.flatpakrepo
          flatpak install -y flathub org.freedesktop.Platform//25.08 org.freedesktop.Sdk//25.08

      - name: Build Flatpak (inline config - Wayland only)
        run: |
          npx @electron-forge/cli make --platform linux --arch x64 --targets @electron-forge/maker-flatpak -- --config '{
            "id": "com.5mind.desktop",
            "runtime": "org.freedesktop.Platform",
            "runtime-version": "25.08",
            "sdk": "org.freedesktop.Sdk",
            "command": "5mind-desktop",
            "finish-args": [
              "--share=network",
              "--socket=wayland",
              "--share=ipc",
              "--device=dri",
              "--socket=session-bus",
              "--filesystem=xdg-documents",
              "--filesystem=xdg-download",
              "--persist=.5mind-desktop",
              "--env=ELECTRON_ENABLE_LOGGING=1",
              "--env=ELECTRON_OZONE_PLATFORM_HINT=wayland"
            ],
            "categories": ["Network", "InstantMessaging", "Chat"]
          }'

      - name: List Flatpak output
        run: ls -la out/make/

      - name: Upload Flatpak to Release
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v2
        with:
          files: out/make/*.flatpak
          tag_name: ${{ github.ref_name }}
          name: 5Mind Desktop ${{ github.ref_name }} (Flatpak)
          generate_release_notes: true
